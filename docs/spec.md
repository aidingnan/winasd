# 1. Specification

本文档用于定义Winasd的spec.

文档首先描述winasd服务启动所需的条件；不满足条件时的行为定义；然后描述主要业务流程的成功路径，定义流程失败时的错误返回；该定义不是完备定义，在系统测试阶段逐步完善。

## 1.1. 服务依赖

服务依赖包括ECC器件的读写，和SATA设备的状态。

### 1.1.1. ECC

ECC读写发生在：

1. 启动阶段读取设备序列号
2. ECC模块初始化
3. 建立channel时与云完成https握手
4. 绑定解绑时的计数器操作

除上述情况外，ECC读写在其他组件的使用情况包括：

1. 首次启动初始化时生成sn, usn等数据时，该操作包含在镜像内；
2. provision设备时，该操作不包含在镜像内；

目前遇到的ecc读写错误常见，包括发生在：

1. winasd启动时atecc命令错误
2. ec模块的preset错误
3. 绑定解绑时的计数器操作

已知原因包括两方面：

1. atecc命令本身可能产生stderr，目前代码作为错误判断依据；
2. 怀疑和led模块发生了竞争；

### 1.1.2. SATA

sata作为依赖性定义，其设计假设是在winasd启动时检查，如果sata处于不可用状态，系统拒绝服务或提供有限服务；

sata在启动时做的检查项目如下：

状态编码|原因|判定方法|业务逻辑|评论
-|-|-|-|-
~~0x01~~|usb-sata硬件或内核驱动故障|检查/dev/sda是否存在|拒绝ble之外所有服务，红灯|只能维修
0x02|未插入ssd|sda size为0（udev设备节点?）|拒绝ble之外所有服务|需用户插入或检查插入ssd
0x03|文件系统非btrfs|使用btrfs命令|拒绝ble之外所有服务|需用户执行格式化操作
0x04|btrfs文件系统无法挂载，btrfs文件系统无法读写|使用mount/umount，在mount后做文件读写测试|拒绝ble之外所有服务|文件系统损坏，建议用户在PC上维修，或者尝试格式化
0x05|暂不使用，可能用于检查btrfs系统残存数据||直接使用
0x80|一切正常|通过所有检查|直接使用

> 0x01暂不使用，0x01和0x02两种情况都并入0x02；已知情况如下：
> - 在USB 3.0模式 + 禁止UAS驱动的情况下，不插入盘时sda也不存在；
> - 在USB 2.0模式 + 允许UAS驱动的情况下，不插入盘时sda存在，但size为0；
>
> 代码里BLE模块如果在启动最初无法获得sata状态时，使用0x00，相当于null。
>
> sata也可以用udev来检查设备节点；如果winasd长期侦听udev事件，可以在sda故障时立刻重启服务；

0x04错误发生时允许格盘存在一个业务风险，绑定用户的业务数据被其他操作者格式化，目前暂不处理该情况；如果station此时无wifi，确认格盘者就是操作者本人需要较多业务步骤（连接wifi）。

但是在客户端上应该检查该用户是否为设备的所有者。如果非所有者不该发出格式化磁盘的操作请求。该需求要求在蓝牙通讯上，设备可提供完整的身份标识（序列号0123xxxxee），客户端可准确判断设备是否为该登录用户所有。

**测试说明**

0x01和0x02合并后，无需单独测试01。

0x02的测试方法是移除ssd，用bluetoothctl检查ble的manufacturer data

0x03的测试方法是先格式化磁盘为其他文件系统，然后测试；

0x04的测试需要一个损毁的btrfs系统，可以使用一个多盘raid0系统里的一个盘做测试；





#### 1.1.2.1. 格式化磁盘操作

格式化磁盘操作之前定义在设备绑定和解绑时的强制行为；

该强制行为可能产生的问题：
1. 用户更新设备，包括购买新设备使用原设备的SSD，或者设备主板维修更换（但SSD保留下来未更换）；当前设计无法直接使用原有设备SSD，且有用户未理解操作风险意外丢失数据的可能；
2. 用户转赠设备，但不包括转赠SSD；当前设计用户无法完成此业务目的；

需要满足的业务要求：
1. 用户可沿用原设备SSD，保留数据；无论是因为维修还是升级发生设备更换；
2. 用户在转赠设备时不受SSD限制；
3. 用户在转赠设备是可以清除私有数据；

> 关于数据残留的说明：
> 
> 目前系统不提供整个ssd的wipeout；所以对于有能力使用btrfs restrore工具的人来说，格式化也可以把数据恢复出来。所以解绑时的格式化提供的数据隐私安全是有限的。

拟考虑的设计变更：

1. 提供独立的磁盘格式化操作，在系统启动至0x03（非btrfs），0x04（btrfs不可用）时，用户先格式化文件系统，完成后才可以继续使用服务；操作要求color code；
2. 解绑业务对SSD无要求；解绑时的格式化为可选操作；建议实现为用户可选操作，即允许数据残留；

> 允许数据残留意味着允许含数据转赠，比如里面放了很多资料后，可以解绑后含数据赠与他人，便于用户分发数据场景。

以上需要增加的业务是：

1. 预装ssd的产品在出厂前需要预格式化ssd

增加的适用场景是：

1. 便于无盘设备销售
2. 便于用户自行更换ssd
3. 允许用户无盘解绑转赠设备
4. 允许用户含数据转赠设备，用于内容分发需求

需客户端支持：

1. 支持在0x03/0x04场景下独立完成格式化磁盘操作；
2. 支持在解绑时可选格式化

需winasd支持：

1. 实现启动时ssd状态检查，并在蓝牙广播里增加一个byte描述ssd状态；
2. 提供基于bluetooth的格式化操作；可以直接在原有网络和绑定操作的characteristic里增加语义；

该操作严格限定在文档定义的状态空间内执行。

需仔细检查原有的服务器端和station代码中关于云端记录的signature/raw的数据内容如何变更（或者不做变更视为无效）。格式化磁盘可以不考虑设计在幂等操作内，如果出现格式化磁盘前供电或者网络故障，可以忽略该步骤。

小结：

ECC问题和磁盘问题列入winasd的服务依赖范围，不设计为运行时状态，如果运行时出现状态问题可立刻退出服务。

ECC和磁盘符合winasd的要求是Winasd提供全部服务的起点，对ssd的操作要么停留在该起点状态，要么回到该起点，目前允许通过退出服务回到该起点。

## 绑定流程

TODO


